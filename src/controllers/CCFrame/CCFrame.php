<?php/*** Controller for creation of frames** @package NocturnalCMF*/class CCFrame extends CObject implements IController{	public function __construct()	{		parent::__construct();		$model = new CMFrame();	}		public function Index()	{		$model = new CMFrame();		$this->views->SetTitle('Frame Controller');		$this->views->AddView('frame/index.tpl.php', array(			'frames'	=> $model->ReadAll(),			'user'		=> $this->user,			),			'primary'		);	}		public function Create()	{		$this->Edit();	}		public function Edit($id=null)	{		$title = (!empty($id)?'Edit':'Create');				$model = new CMFrame($id);				$form = new CFormFrame();				$form->AddElement(new CFormElementText('title', array('value' => $model['title'])));		$form->AddElement(new CFormElementText('key', array('value' => $model['key'])));				$cont = $model->getAllContent();				foreach($model->getAllRegions() as $region)		{			$selected = "None";			if (isset($model['content'][$region]))			{				$content = new CMContent($model['content'][$region]);				$selected = $content['key'];			}			$array = $cont;			for ($i=0;$i<count($array); $i++)			{				if ($array[$i]==$selected)				{					$array[$i] = array('selected' => 'selected', 'value' => $array[$i]);					break;				}			}						$form->AddElement(new CFormElementSelect($region, array('options' => $array)));		}				$form->AddElement(new CFormElementSubmit('Save', array('callback' => array($this, 'DoSaveFrame'))));				if ($id!=null)		{			$form->AddElement(new CFormElementSubmit('Remove', array('callback' => array($this, 'DoRemoveFrame'))));		}				$form->AddElement(new CFormElementHidden('id', array('value' => $id)));				$form->SetValidation('title', array('not_empty'));		$form->SetValidation('key', array('not_empty'));				$form->Check();				$this->views->SetTitle($title.' frame '.$id);		$this->views->AddView('frame/edit.tpl.php', array(			'form'	=> $form->GetHTML(),			'title'	=> $title,			'user'	=> $this->user,			),			'primary');	}		public function DoSaveFrame($form)	{		$id	= $form['id']['value'];		if ($this->user->InGroup('admin'))		{			$title		= $form['title']['value'];			$key		= $form['key']	['value'];			$regions = array();			foreach($form->elements as $element)			{				if ($element['type']=='select' && $element['value']!='none')				{					$regions[$element['name']] = $element['value'];				}			}			$model = new CMFrame($id);			if ($model->SaveFrame($title, $key, $regions))			{				$this->session->AddMessage('success', 'Frame saved.');				$this->RedirectToController('index');			}			else			{				$this->session->AddMessage('error', 'Unable to save frame.');			}		}		$this->RedirectToController('edit/'.$id);	}		public function DoRemoveFrame($form)	{		$id	= $form['id']['value'];		if ($this->user->InGroup('admin'))		{			$model = new CMFrame($id);			if ($model->RemoveFrame())			{				$this->session->AddMessage('success', 'Frame removed.');				$this->RedirectToController('index');			}			else			{				$this->session->AddMessage('error', 'Unable to remove frame.');			}		}		$this->RedirectToController('edit/'.$id);	}		public function View($id)	{		$model = new CMFrame($id);		if (empty($model['deleted']))		{			$this->views->SetTitle($model['title']);						foreach($model['content'] as $region => $id)			{				$page = new CMContent($id);				if ($page['type']=='page')				{					$text = "";					if ($region==$this->config['theme']['primary-region'])					{						$text .= "<h2>{$page['title']}</h2>";					}					else					{						$text .= "<h3>{$page['title']}</h3>";					}					$text .= CMContent::Filter($page['data'], $page['filter']);					if ($this->user->InGroup('admin') || $this->user->InGroup('contentmanager'))					{						$text .= '<p><button class="smaller" onclick=\'javascript:location.href="'.$this->request->CreateUrl('content/edit/'.$page['id']).'"\'><img src="'.$this->request->base_url.'site/data/nocturnal/edit.png'.'" />Edit</button></p>';					}					$this->views->AddString($text, array(						'content'	=> $page,						),						$region);				}			}		}	}}